<script type="text/javascript">
    
    RED.nodes.registerType('Sonoff PIR', {
        category: 'Sonoff',
        color: '#28AFB0',
        defaults: {
            mode:{ value: '0'},
            broker: { type: 'mqtt-broker', required: true },
            device: { value: 'sonoff', required: true },
            lightDepend:  { value: 'always' },
            lon: {value:"", validate:function(v) {return ((v>=-180) && (v<=180));} },
            lat: {value:"", validate:function(v) {return ((v>=-90) && (v<=90));} },
            start: {value:"sunrise", required:true},
            startOffset: {value:0, required:true},
            
            end: {value:"sunset", required:true},
            endOffset: {value:0, required:true},
            offAfter: {value:300, required:true, validate:function(v) {return ((v>=5) && (v<=24*60*60));} },
            name: { value: ''},
            cmdPrefix: { value: 'cmnd' },
            telePrefix: { value: 'tele' },
            keyIds: { required: false },
        },
        icon: 'sun.png',
        inputs: 1,
        outputs: 2,
        label: function() {
            return this.name || this.device;
        },
        oneditprepare: function() {
         
          var timStr = function (time){
            return time.getHours() + ':' + time.getMinutes().toString().padStart(2,'0');
          }
          let addTimes = ()=>{
            var times = SunCalc.getTimes(now, $("#node-input-lat").val(), $("#node-input-lat").val());
            $("#node-input-start option, #node-input-end option").each(function(elem){
              var html = $(elem).html();
              html+=`(${timStr(times[$(elem).val()])})`;
            })
          }
          if (($("#node-input-lat").val() === "") && ($("#node-input-lon").val() === "")) {
              if ("geolocation" in navigator) {
                  navigator.geolocation.getCurrentPosition(function(position) {
                      $("#node-input-lat").val(Number(position.coords.latitude.toFixed(5)));
                      $("#node-input-lon").val(Number(position.coords.longitude.toFixed(5)));
                    //  addTimes();
                  });
              }else{
            //    addTimes();
              }
          }

        }
    });
    </script>
    
    <script type="text/x-red" data-template-name="Sonoff PIR">
        <div class="form-row">
            <label for="node-input-mode"><i class="fa fa-wrench"></i><span> Mode</span></label>
            <select type="text" id="node-input-mode" style="width:70%;">            
                <option value="0">%prefix%/%topic%/</option>
                <option value="1">%topic%/%prefix%/</option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-device"><i class="icon-tag"></i> Id</label>
            <input type="text" id="node-input-device" placeholder="Sonoff id (Default: sonoff)">
        </div>
        <div class="form-row">
            <label for="node-input-broker"><i class="fa fa-globe"></i> Mqtt</label>
            <input type="text" id="node-input-broker">
        </div>
        <div class="form-row">
            <label for="node-input-name"><i class="icon-tag"></i> Name</label>
            <input type="text" id="node-input-name" placeholder="Name">
        </div>
        <div class="form-row">
            <label for="node-input-cmdPrefix"><i class="fa fa-comment"></i> cmd</label>
            <input type="text" id="node-input-cmdPrefix" placeholder="cmdPrefix (Default: cmd)">
        </div>
        <div class="form-row">
            <label for="node-input-telePrefix"><i class="fa fa-comment"></i> tele</label>
            <input type="text" id="node-input-telePrefix" placeholder="telePrefix (Default: tele)">
        </div>
        <div class="form-row">
            <label for="node-input-keyIds"><i class="fa fa-comment"></i> key-id(s)</label>
            <input type="text" id="node-input-keyIds" placeholder="key-ids">
        </div>
        <div class="form-row">
            <label for="node-input-lightDepend"><i class="fa fa-clock-o"></i>Switch when</label>
            <select id="node-input-lightDepend" style='width:70%'>
              <option value="always">Always, day and night</option>
              <option value="night">Only at night</option>
              <option value="day">Only during the day</option>
            </select>
          </div>
        <div class="form-row">
            <label for="node-input-lat"><i class="fa fa-globe"></i> Latitude</label>
            <input type="text" id="node-input-lat" placeholder="51.025">
          </div>
          <div class="form-row">
            <label for="node-input-lon"><i class="fa fa-globe"></i> Longitude</label>
            <input type="text" id="node-input-lon" placeholder="-1.4">
          </div>
          <div class="form-row">
            <label for="node-input-start"><i class="fa fa-clock-o"></i> Sunrise</label>
            <select id="node-input-start" style='width:70%'>
              <option value="sunrise">Sunrise start</option>
              <option value="sunriseEnd">Sunrise end</option>
              <option value="dawn">Dawn, morning civil twilight starts</option>
              <option value="goldenHourEnd">End of morning golden hour</option>
              <option value="nauticalDawn">Morning nautical twilight starts</option>
              <option value="nightEnd">Morning astronomical twilight starts</option>
            </select>
          </div>
          <div class="form-row">
            <label for="node-input-startOffset"><i class="fa fa-comment"></i>Start-offset minutes</label>
            <input type="number" id="node-input-startOffset" placeholder="min int">
          </div>
          <div class="form-row">
            <label for="node-input-end"><i class="fa fa-clock-o"></i> Sunset</label>
            <select id="node-input-end" style='width:70%'>
              <option value="sunset">Sunset, civil twilight starts</option>
              <option value="sunsetStart">Sunset start</option>
              <option value="goldenHour">Start of evening golden hour</option>
              <option value="dusk">Dusk, Evening astronomical twilight starts</option>
              <option value="nauticalDusk">Evening nautical twilight starts</option>
              <option value="night">Dark enough for astronomy</option>
            </select>
          </div>
          <div class="form-row">
            <label for="node-input-endOffset"><i class="fa fa-comment"></i>End-offset minutes</label>
            <input type="number" id="node-input-endOffset" placeholder="min int">
          </div>
          <div class="form-row">
            <label for="node-input-offAfter"><i class="fa fa-comment"></i>Off-delay seconds</label>
            <input type="number" id="node-input-offAfter" placeholder="min int">
          </div>
         
    </script>